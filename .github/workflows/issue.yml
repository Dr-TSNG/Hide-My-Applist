name: Close issue

on:
  issues:
    types: [labeled]

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - name: Check if issue title exists
      uses: actions/github-script@v6.2.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          let response = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });
          let data = response['data'];
          
          data.forEach(function(issue){
            var title = issue['title'];
            var labels = issue['labels'];
            var spam = false;
            for(var i=0,l=labels.length;i<l;i++){
              if(labels[i]['name'] == 'bug'){
                 if(title.substr(0, 5) !== '[Bug]' || title == '[Bug]' || title == '[Bug] '){
                      spam = true;
                  }
              }
            }
            if(spam){
                var id = issue['number'];
                github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: id,
                    labels: ["spam"]
                });
            }            
          });
    - name: Close spam and invalid issues
      uses: actions/github-script@v6.2.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          let response = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });
          let data = response['data'];
          
          data.forEach(function(issue){
            var labels = issue['labels'];
            var close = false;
            var lock = false;
            for(var i=0,l=labels.length;i<l;i++){
                if(labels[i]['name'] == 'invalid' || labels[i]['name'] == 'spam'){
                    close = true;
                }
                if(labels[i]['name'] == 'spam'){
                    lock = true;
                }
            }
            if(close){
                var id = issue['number'];
                github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: id,
                    body: 'This issue has been marked as **spam** or **invalid**. For feedback please **follow the rules in the report form**, then open a new issue.'
                });
                github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: id,
                    name: 'bug'
                });
                github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: id,
                  state: 'closed'
                });
            }
            if(lock){
                var lid = issue['number'];
                github.rest.issues.lock({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: id,
                  lock_reason: "spam"
                });
            }                
          });
    - name: Del runs
      uses: actions/github-script@v6.2.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          let response = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'issue.yml'
          });
          response.forEach(function(workflow_runs){
            var id = workflow_runs['id'];
            github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: id
            });
          });
